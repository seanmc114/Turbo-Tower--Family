<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Turbo Family Tower</title>
  <style>
    :root{
      --card: rgba(255,255,255,0.92);
      --line: rgba(8,12,24,0.14);
      --text: rgba(8,12,24,0.94);
      --muted: rgba(8,12,24,0.62);
      --blue:#1d4fff;
      --blue2:#0b2bbd;
      --green:#00a86b;
      --bad:#d61f2c;
      --shadow: 0 18px 60px rgba(10,15,30,0.16);
      --radius: 18px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:var(--font); color:var(--text);
      background:
        radial-gradient(900px 600px at 15% 12%, rgba(29,79,255,0.30), transparent 62%),
        radial-gradient(900px 600px at 85% 20%, rgba(0,168,107,0.26), transparent 62%),
        radial-gradient(800px 520px at 50% 95%, rgba(255,140,0,0.22), transparent 62%),
        linear-gradient(180deg, #f2f6ff, #eaf0ff);
    }
    .app{min-height:100%; display:flex; flex-direction:column}
    header{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:16px 18px 10px; flex-wrap:wrap;
    }
    .brand{display:flex; align-items:center; gap:12px}
    .logo{
      width:46px; height:46px; display:grid; place-items:center;
      background: linear-gradient(180deg, rgba(255,255,255,1), rgba(255,255,255,0.9));
      border:1px solid var(--line); border-radius:16px; box-shadow:var(--shadow);
      font-size:22px;
    }
    .title{font-weight:1000}
    .subtitle{color:var(--muted); font-size:13px; margin-top:2px}

    main{
      flex:1;
      display:grid;
      grid-template-columns: 1.45fr 0.75fr;
      gap:14px;
      max-width: 1240px;
      width:100%;
      margin:0 auto;
      padding: 6px 18px 18px;
    }
    @media (max-width: 980px){
      main{grid-template-columns: 1fr; }
    }

    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }

    .canvasWrap{
      padding:0;
      overflow:hidden;
      position:relative;
      min-height: 700px;
    }

    /* Level background ‚Äúimage‚Äù is applied here by JS via style.backgroundImage */
    .canvasBG{
      position:absolute; inset:0;
      border-radius: var(--radius);
      background-size: cover;
      background-position: center;
      filter: saturate(1.05) contrast(1.02);
    }
    .canvasBG::after{
      content:"";
      position:absolute; inset:0;
      border-radius: var(--radius);
      background:
        radial-gradient(800px 500px at 20% 10%, rgba(255,255,255,0.70), transparent 60%),
        radial-gradient(800px 500px at 85% 20%, rgba(255,255,255,0.55), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.20));
      pointer-events:none;
    }

    #stage{
      position:relative;
      width:100%;
      height: 700px;
      display:block;
      border-radius: var(--radius);
      touch-action: none;
    }

    .hudTop{
      position:absolute; inset:12px 12px auto 12px;
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      pointer-events:none;
      z-index:3;
    }
    .pill{
      pointer-events:auto;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(8,12,24,0.12);
      background: rgba(255,255,255,0.92);
      font-size:12px;
      color: var(--muted);
      font-weight:1000;
    }
    .pill strong{color:var(--text)}
    .pill.level{
      background: linear-gradient(180deg, rgba(29,79,255,0.18), rgba(29,79,255,0.10));
      border-color: rgba(29,79,255,0.28);
      color: rgba(11,43,189,0.95);
    }

    .hintOverlay{
      position:absolute; inset:auto 12px 12px 12px;
      pointer-events:none;
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      color: rgba(8,12,24,0.70);
      font-weight:1000;
      font-size:12px;
      z-index:3;
    }
    .hintOverlay span{
      background: rgba(255,255,255,0.82);
      border: 1px solid rgba(8,12,24,0.10);
      padding: 8px 10px;
      border-radius: 999px;
    }

    .btnRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .btn{
      border:1px solid var(--line);
      background:#fff;
      color: var(--text);
      border-radius:14px;
      padding:10px 12px;
      cursor:pointer;
      transition: transform .10s ease, border-color .10s ease, background .10s ease;
      font-weight:1000;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(8,12,24,0.22)}
    .btn.primary{
      background: linear-gradient(180deg, rgba(29,79,255,0.28), rgba(29,79,255,0.16));
      border-color: rgba(29,79,255,0.60);
      color: var(--blue2);
    }
    .btn.good{
      background: linear-gradient(180deg, rgba(0,168,107,0.18), rgba(0,168,107,0.10));
      border-color: rgba(0,168,107,0.45);
      color: rgba(0,110,70,1);
    }
    .btn.bad{
      background: linear-gradient(180deg, rgba(214,31,44,0.16), rgba(214,31,44,0.10));
      border-color: rgba(214,31,44,0.40);
      color: rgba(150,18,26,1);
    }

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .label{font-size:12px; color: var(--muted); font-weight:1000}
    select{
      border:1px solid var(--line);
      border-radius: 12px;
      padding:10px 12px;
      background:#fff;
      font-weight:1000;
      outline:none;
    }
    select:focus{border-color: rgba(29,79,255,0.60); box-shadow: 0 0 0 4px rgba(29,79,255,0.16)}
    .prompt{
      font-size:16px;
      font-weight:1000;
      margin:10px 0 0;
    }
    .mini{font-size:12px; color:var(--muted)}
    .spellBox{
      margin-top:10px;
      padding:12px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,0.90);
    }
    .spell{
      font-size:22px;
      letter-spacing: 1px;
      font-weight:1000;
      word-break: break-word;
      min-height: 28px;
    }

    .msg{
      margin-top:10px;
      padding:10px 12px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(8,12,24,0.03);
      font-weight:1000;
    }
    .msg.good{border-color: rgba(0,168,107,0.40); background: rgba(0,168,107,0.14); color: rgba(0,110,70,1)}
    .msg.bad{border-color: rgba(214,31,44,0.40); background: rgba(214,31,44,0.12); color: rgba(150,18,26,1)}

    .list{
      margin-top:10px;
      border-top:1px solid var(--line);
      padding-top:10px;
      display:grid;
      gap:8px;
      max-height: 320px;
      overflow:auto;
    }
    .chip{
      display:flex; justify-content:space-between; gap:10px;
      padding:10px 10px;
      border:1px solid rgba(8,12,24,0.10);
      border-radius: 14px;
      background: rgba(255,255,255,0.92);
      font-weight:1000;
      align-items:center;
    }
    .chip.done{
      border-color: rgba(0,168,107,0.30);
      background: linear-gradient(180deg, rgba(0,168,107,0.14), rgba(255,255,255,0.92));
    }
    .chip small{color:var(--muted); font-weight:1000}

    footer{
      text-align:center;
      padding: 10px 14px 16px;
      color: rgba(8,12,24,0.55);
      font-weight:1000;
      letter-spacing:0.3px;
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="brand">
      <div class="logo">üßä</div>
      <div>
        <div class="title">Turbo Family Tower</div>
        <div class="subtitle">Click blocks to spell the Spanish word ¬∑ drag to rotate ¬∑ scroll to zoom</div>
      </div>
    </div>
    <div class="row">
      <div class="label">Level</div>
      <select id="levelSel" aria-label="Level"></select>
      <button class="btn" id="btnNew">New Round</button>
      <button class="btn" id="btnScores">High Scores</button>
    </div>
  </header>

  <main>
    <div class="card canvasWrap">
      <div id="canvasBG" class="canvasBG"></div>
      <canvas id="stage"></canvas>

      <div class="hudTop">
        <div class="pill level">üß† Level <strong id="levelBadge">1</strong></div>
        <div class="pill">‚è±Ô∏è <strong id="time">0:00</strong></div>
        <div class="pill">‚≠ê Score <strong id="score">0</strong></div>
        <div class="pill">üî• Streak <strong id="streak">0</strong></div>
        <div class="pill">üéØ Left <strong id="left">0</strong></div>
      </div>

      <div class="hintOverlay">
        <span>üåÄ Drag to rotate</span>
        <span>üîé Scroll to zoom</span>
      </div>
    </div>

    <div class="card">
      <div class="label">Prompt</div>
      <div class="prompt" id="prompt">‚Äî</div>
      <div class="mini" id="hintLine">Hints cost points and reset streak.</div>

      <div class="spellBox">
        <div class="label">Your spelling</div>
        <div class="spell" id="spelling">‚Äî</div>
        <div class="mini">Tip: phrases can include spaces (e.g. <em>salir con</em>). Use ‚ÄúClear‚Äù if you misclick.</div>
      </div>

      <div class="btnRow">
        <button class="btn primary" id="btnSubmit">Submit</button>
        <button class="btn" id="btnClear">Clear</button>
        <button class="btn good" id="btnShuffle">Shuffle Tower</button>
        <button class="btn bad" id="btnHint">Hint</button>
      </div>

      <div class="msg" id="msg" style="display:none"></div>

      <div class="label" style="margin-top:12px">This round</div>
      <div class="list" id="roundList"></div>
    </div>
  </main>

  <footer>¬© 2026 Synge Street Games Lab</footer>
</div>

<script type="module">
  import * as THREE from "https://unpkg.com/three@0.160.0/build/three.module.js";

  // ===================== FAMILY DATASET (Levels 1‚Äì10) =====================
  const FAMILY = {
    1: [
      { en:"mother", answers:["madre","mam√°"] },
      { en:"father", answers:["padre","pap√°"] },
      { en:"brother", answers:["hermano"] },
      { en:"sister", answers:["hermana"] },
      { en:"parents", answers:["padres"] },
      { en:"family", answers:["familia"] },
      { en:"son", answers:["hijo"] },
      { en:"daughter", answers:["hija"] },
      { en:"children", answers:["hijos"] },
      { en:"grandmother", answers:["abuela"] },
      { en:"grandfather", answers:["abuelo"] },
      { en:"grandparents", answers:["abuelos"] }
    ],
    2: [
      { en:"uncle", answers:["t√≠o"] },
      { en:"aunt", answers:["t√≠a"] },
      { en:"cousin (male)", answers:["primo"] },
      { en:"cousin (female)", answers:["prima"] },
      { en:"nephew", answers:["sobrino"] },
      { en:"niece", answers:["sobrina"] },
      { en:"husband", answers:["marido","esposo"] },
      { en:"wife", answers:["mujer","esposa"] },
      { en:"couple", answers:["pareja"] },
      { en:"relative", answers:["pariente","familiar"] },
      { en:"stepfather", answers:["padrastro"] },
      { en:"stepmother", answers:["madrastra"] }
    ],
    3: [
      { en:"stepson", answers:["hijastro"] },
      { en:"stepdaughter", answers:["hijastra"] },
      { en:"half-brother", answers:["medio hermano","hermanastro"] },
      { en:"half-sister", answers:["media hermana","hermanastra"] },
      { en:"only child", answers:["hijo √∫nico","hija √∫nica"] },
      { en:"twins", answers:["gemelos"] },
      { en:"single-parent family", answers:["familia monoparental"] },
      { en:"to get married", answers:["casarse"] },
      { en:"wedding", answers:["boda"] },
      { en:"divorce", answers:["divorcio"] },
      { en:"to separate", answers:["separarse"] },
      { en:"to live together", answers:["vivir juntos","convivir"] }
    ],
    4: [
      { en:"to raise (children)", answers:["criar","educar"] },
      { en:"to bring up", answers:["criar","educar"] },
      { en:"to look after", answers:["cuidar"] },
      { en:"to support (a family)", answers:["mantener"] },
      { en:"household chores", answers:["tareas dom√©sticas"] },
      { en:"to share chores", answers:["repartir las tareas","compartir las tareas"] },
      { en:"to argue", answers:["discutir"] },
      { en:"to get along", answers:["llevarse bien"] },
      { en:"to fall out", answers:["llevarse mal"] },
      { en:"relationship", answers:["relaci√≥n"] },
      { en:"to meet (someone)", answers:["conocer"] },
      { en:"to date", answers:["salir con"] }
    ],
    5: [
      { en:"engaged", answers:["comprometido","prometido"] },
      { en:"fianc√©", answers:["prometido"] },
      { en:"fianc√©e", answers:["prometida"] },
      { en:"to propose", answers:["pedir matrimonio","proponer matrimonio"] },
      { en:"to break up", answers:["romper"] },
      { en:"to reconcile", answers:["reconciliarse"] },
      { en:"to trust", answers:["confiar"] },
      { en:"to respect", answers:["respetar"] },
      { en:"to argue with", answers:["discutir con"] },
      { en:"to forgive", answers:["perdonar"] },
      { en:"to be close", answers:["ser cercano"] },
      { en:"to be related", answers:["estar emparentado"] }
    ],
    6: [
      { en:"in-laws", answers:["suegros"] },
      { en:"mother-in-law", answers:["suegra"] },
      { en:"father-in-law", answers:["suegro"] },
      { en:"brother-in-law", answers:["cu√±ado"] },
      { en:"sister-in-law", answers:["cu√±ada"] },
      { en:"godmother", answers:["madrina"] },
      { en:"godfather", answers:["padrino"] },
      { en:"to adopt", answers:["adoptar"] },
      { en:"adoption", answers:["adopci√≥n"] },
      { en:"to have a baby", answers:["tener un beb√©"] },
      { en:"pregnant", answers:["embarazada"] },
      { en:"to give birth", answers:["dar a luz"] }
    ],
    7: [
      { en:"childhood", answers:["infancia"] },
      { en:"teenager", answers:["adolescente"] },
      { en:"adult", answers:["adulto"] },
      { en:"elderly", answers:["anciano","mayor"] },
      { en:"generation", answers:["generaci√≥n"] },
      { en:"family tree", answers:["√°rbol geneal√≥gico"] },
      { en:"to inherit", answers:["heredar"] },
      { en:"inheritance", answers:["herencia"] },
      { en:"to take after", answers:["parecerse a"] },
      { en:"to resemble", answers:["parecerse a"] },
      { en:"to care for", answers:["cuidar de"] },
      { en:"to depend on", answers:["depender de"] }
    ],
    8: [
      { en:"to be overprotective", answers:["ser sobreprotector"] },
      { en:"to set rules", answers:["poner reglas","establecer reglas"] },
      { en:"to allow", answers:["permitir"] },
      { en:"to forbid", answers:["prohibir"] },
      { en:"to punish", answers:["castigar"] },
      { en:"to spoil (a child)", answers:["malcriar","mimar"] },
      { en:"to behave", answers:["portarse"] },
      { en:"to obey", answers:["obedecer"] },
      { en:"to be grounded", answers:["estar castigado"] },
      { en:"to argue (noun)", answers:["discusi√≥n"] },
      { en:"to reconcile (noun)", answers:["reconciliaci√≥n"] },
      { en:"to compromise", answers:["llegar a un acuerdo","comprometerse"] }
    ],
    9: [
      { en:"domestic violence", answers:["violencia dom√©stica"] },
      { en:"to report", answers:["denunciar"] },
      { en:"support network", answers:["red de apoyo"] },
      { en:"to seek help", answers:["buscar ayuda"] },
      { en:"to cope", answers:["afrontar"] },
      { en:"to overcome", answers:["superar"] },
      { en:"to be independent", answers:["ser independiente"] },
      { en:"to move out", answers:["mudarse","irse de casa"] },
      { en:"to move in", answers:["mudarse","instalarse"] },
      { en:"to take responsibility", answers:["asumir la responsabilidad"] },
      { en:"to set boundaries", answers:["poner l√≠mites","establecer l√≠mites"] },
      { en:"mutual respect", answers:["respeto mutuo"] }
    ],
    10: [
      { en:"family breakdown", answers:["ruptura familiar"] },
      { en:"dysfunctional family", answers:["familia disfuncional"] },
      { en:"to mediate", answers:["mediar"] },
      { en:"mediation", answers:["mediaci√≥n"] },
      { en:"to foster", answers:["acoger"] },
      { en:"foster family", answers:["familia de acogida"] },
      { en:"to be estranged", answers:["estar distanciado"] },
      { en:"to reconcile (formal)", answers:["reconciliarse"] },
      { en:"to maintain contact", answers:["mantener el contacto"] },
      { en:"to cut ties", answers:["romper lazos"] },
      { en:"to provide for", answers:["proveer","mantener"] },
      { en:"to be supportive", answers:["apoyar","ser comprensivo"] }
    ]
  };

  // Kid-friendly checking: accents not required, √± can be typed as n, punctuation ignored
  const ACC = {"√°":"a","√©":"e","√≠":"i","√≥":"o","√∫":"u","√º":"u","√Å":"A","√â":"E","√ç":"I","√ì":"O","√ö":"U","√ú":"U"};
  const stripAccents = (s)=> String(s).split("").map(ch=>ACC[ch]||ch).join("");
  const norm = (s)=> stripAccents(String(s||"").toLowerCase().trim())
    .replace(/[¬ø?¬°!.,;:()\[\]{}"‚Äú‚Äù'‚Äô]/g," ")
    .replace(/\s+/g," ")
    .replace(/√±/g,"n");

  const $ = (id)=> document.getElementById(id);
  const levelSel = $("levelSel");
  const btnNew = $("btnNew");
  const btnScores = $("btnScores");
  const btnSubmit = $("btnSubmit");
  const btnClear = $("btnClear");
  const btnShuffle = $("btnShuffle");
  const btnHint = $("btnHint");

  const timeEl = $("time");
  const scoreEl = $("score");
  const streakEl = $("streak");
  const leftEl = $("left");
  const promptEl = $("prompt");
  const hintLine = $("hintLine");
  const spellingEl = $("spelling");
  const msgEl = $("msg");
  const roundList = $("roundList");
  const levelBadge = $("levelBadge");
  const canvasBG = $("canvasBG");

  // ----- Level background ‚Äúimages‚Äù (SVG data URIs, no files needed) -----
  // If you ever want real photos: replace each entry with url('images/level1.jpg') etc.
  function bgSvg(themeColorA, themeColorB, icon){
    const svg =
`<svg xmlns='http://www.w3.org/2000/svg' width='1600' height='900' viewBox='0 0 1600 900'>
  <defs>
    <linearGradient id='g' x1='0' y1='0' x2='1' y2='1'>
      <stop offset='0' stop-color='${themeColorA}'/>
      <stop offset='1' stop-color='${themeColorB}'/>
    </linearGradient>
    <radialGradient id='r' cx='30%' cy='20%' r='70%'>
      <stop offset='0' stop-color='rgba(255,255,255,0.55)'/>
      <stop offset='1' stop-color='rgba(255,255,255,0)'/>
    </radialGradient>
  </defs>
  <rect width='1600' height='900' fill='url(#g)'/>
  <rect width='1600' height='900' fill='url(#r)'/>
  <g opacity='0.20' fill='white'>
    <circle cx='260' cy='160' r='120'/>
    <circle cx='1360' cy='240' r='160'/>
    <circle cx='1160' cy='760' r='200'/>
    <circle cx='360' cy='720' r='220'/>
  </g>
  <g opacity='0.24' fill='white' font-family='system-ui,Segoe UI,Roboto' font-weight='900'>
    <text x='80' y='190' font-size='120'>${icon}</text>
    <text x='1400' y='840' font-size='120'>${icon}</text>
  </g>
</svg>`;
    return "url(\"data:image/svg+xml;utf8," + encodeURIComponent(svg) + "\")";
  }

  const LEVEL_BG = {
    1: bgSvg("#9be7ff","#d6fff3","üë™"),
    2: bgSvg("#a7c7ff","#ffe0f1","üè°"),
    3: bgSvg("#c7ffd8","#fff3b0","üß©"),
    4: bgSvg("#ffd1a8","#c7f0ff","üßπ"),
    5: bgSvg("#ffb3d9","#c7d2ff","üíû"),
    6: bgSvg("#b6ffea","#c8ffd0","üçº"),
    7: bgSvg("#bde0fe","#caffbf","üå≥"),
    8: bgSvg("#ffd6a5","#fdffb6","üìè"),
    9: bgSvg("#ffc6ff","#bdb2ff","üõ°Ô∏è"),
    10:bgSvg("#bdb2ff","#a0c4ff","üèÜ")
  };

  function applyLevelBackground(level){
    canvasBG.style.backgroundImage =
      "linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.20))," + (LEVEL_BG[level] || LEVEL_BG[1]);
  }

  // ---------- Colour palette (brighter blocks) ----------
  const LEVEL_HUES = [205, 190, 160, 135, 320, 110, 80, 30, 350, 260]; // 1..10
  function rand(min,max){ return min + Math.random()*(max-min); }
  function hslToHex(h,s,l){
    s/=100; l/=100;
    const k = n => (n + h/30) % 12;
    const a = s * Math.min(l, 1 - l);
    const f = n => l - a * Math.max(-1, Math.min(k(n) - 3, Math.min(9 - k(n), 1)));
    const toHex = x => Math.round(255 * x).toString(16).padStart(2,"0");
    return `#${toHex(f(0))}${toHex(f(8))}${toHex(f(4))}`;
  }
  function brightColour(level){
    const base = LEVEL_HUES[Math.max(0, Math.min(9, level-1))];
    const h = (base + rand(-18,18) + 360) % 360;
    const s = rand(68, 90);
    const l = rand(56, 72);
    return hslToHex(h,s,l);
  }

  // ---------- Game state ----------
  const STATE = {
    level: 1,
    roundSize: 8,
    round: [],
    currentIndex: 0,
    currentItem: null,
    acceptedAnswers: [],
    selectedBlocks: [],
    selectedText: "",
    startedAt: 0,
    timerId: null,
    score: 0,
    streak: 0,
    hintsUsed: 0,
    done: 0
  };

  // ---------- Three.js scene ----------
  const canvas = $("stage");
  const renderer = new THREE.WebGLRenderer({ canvas, antialias:true, alpha:true });
  renderer.setPixelRatio(Math.min(2, window.devicePixelRatio || 1));

  const scene = new THREE.Scene();
  scene.fog = new THREE.Fog(0xf2f6ff, 12, 70);

  const camera = new THREE.PerspectiveCamera(45, 1, 0.1, 200);

  // More top-down orbit camera
  const target = new THREE.Vector3(0, 2.3, 0);
  let radius = 24;
  let theta = Math.PI * 0.25;
  let phi   = Math.PI * 0.30; // MORE top-down by default
  const phiMin = Math.PI * 0.20;
  const phiMax = Math.PI * 0.48;
  const radMin = 16;
  const radMax = 34;

  function updateCamera(){
    const sinPhi = Math.sin(phi);
    camera.position.set(
      target.x + radius * sinPhi * Math.cos(theta),
      target.y + radius * Math.cos(phi),
      target.z + radius * sinPhi * Math.sin(theta)
    );
    camera.lookAt(target);
  }

  const hemi = new THREE.HemisphereLight(0xffffff, 0x445566, 1.05);
  scene.add(hemi);
  const dir = new THREE.DirectionalLight(0xffffff, 1.0);
  dir.position.set(14, 24, 12);
  scene.add(dir);

  const groundGeo = new THREE.PlaneGeometry(90, 90);
  const groundMat = new THREE.MeshStandardMaterial({ color:0xffffff, transparent:true, opacity:0.34, roughness:1 });
  const ground = new THREE.Mesh(groundGeo, groundMat);
  ground.rotation.x = -Math.PI/2;
  ground.position.y = -0.85;
  scene.add(ground);

  // Tower settings
  const GRID = 7;
  const HEIGHT = 7;
  const SIZE = 1.24;
  const GAP = 0.14;

  const origin = new THREE.Vector3(
    -(GRID-1)*(SIZE+GAP)/2,
    0,
    -(GRID-1)*(SIZE+GAP)/2
  );

  const raycaster = new THREE.Raycaster();
  const mouse = new THREE.Vector2();
  let hovered = null;

  const blockGroup = new THREE.Group();
  scene.add(blockGroup);

  function makeLetterTexture(letter){
    const c = document.createElement("canvas");
    c.width = 256; c.height = 256;
    const ctx = c.getContext("2d");

    ctx.fillStyle = "rgba(255,255,255,0.98)";
    ctx.fillRect(0,0,c.width,c.height);

    // border
    ctx.strokeStyle = "rgba(8,12,24,0.22)";
    ctx.lineWidth = 14;
    ctx.strokeRect(16,16,c.width-32,c.height-32);

    // big letter
    ctx.fillStyle = "rgba(8,12,24,0.92)";
    ctx.font = "900 178px system-ui, -apple-system, Segoe UI, Roboto";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(letter, 128, 142);

    // playful highlight
    ctx.fillStyle = "rgba(29,79,255,0.12)";
    ctx.beginPath(); ctx.arc(72,72,84,0,Math.PI*2); ctx.fill();

    const tex = new THREE.CanvasTexture(c);
    tex.anisotropy = renderer.capabilities.getMaxAnisotropy?.() || 1;
    return tex;
  }

  function makeBlock(letter, pos, level){
    const geo = new THREE.BoxGeometry(SIZE, SIZE, SIZE);

    // colourful sides
    const sideHex = new THREE.Color(brightColour(level)).getHex();
    const sideMat = new THREE.MeshStandardMaterial({
      color: sideHex,
      roughness: 0.55,
      metalness: 0.06
    });

    // top with letter
    const topMat = new THREE.MeshStandardMaterial({
      color: 0xffffff,
      roughness: 0.42,
      metalness: 0.04,
      map: makeLetterTexture(letter)
    });

    const mats = [sideMat, sideMat, topMat, sideMat, sideMat, sideMat];

    const mesh = new THREE.Mesh(geo, mats);
    mesh.position.copy(pos);
    mesh.userData.letter = letter;
    mesh.userData.alive = true;
    mesh.userData.selected = false;
    mesh.userData.sideHex = sideHex;
    return mesh;
  }

  function randomLetterBag(level){
    const items = FAMILY[level] || [];
    const pool = [];
    for(const it of items){
      for(const a of it.answers){
        norm(a).split("").forEach(ch=>{
          if(/[a-z]/.test(ch)) pool.push(ch.toUpperCase());
          if(ch===" ") pool.push(" ");
        });
      }
    }
    const fallback = "AAABCDEEEFGHIJKLMN√ëNOOOPQRSTUUVWXYZ".replace(/[^A-Z√ë]/g,"").split("");
    return pool.length ? pool : fallback;
  }

  function buildTower(level){
    while(blockGroup.children.length) blockGroup.remove(blockGroup.children[0]);

    const bag = randomLetterBag(level);
    const pick = (arr)=> arr[Math.floor(Math.random()*arr.length)];

    for(let y=0; y<HEIGHT; y++){
      for(let x=0; x<GRID; x++){
        for(let z=0; z<GRID; z++){
          const holeChance = (y===0)?0.06:(y<3?0.12:0.22);
          if(Math.random() < holeChance) continue;

          const letter = pick(bag);
          const pos = new THREE.Vector3(
            origin.x + x*(SIZE+GAP),
            y*(SIZE+GAP),
            origin.z + z*(SIZE+GAP)
          );
          blockGroup.add(makeBlock(letter, pos, level));
        }
      }
    }
  }

  function resize(){
    const rect = canvas.getBoundingClientRect();
    const w = Math.max(320, Math.floor(rect.width));
    const h = Math.max(520, Math.floor(rect.height));
    renderer.setSize(w, h, false);
    camera.aspect = w / h;
    camera.updateProjectionMatrix();
  }
  window.addEventListener("resize", resize);

  function animate(){
    requestAnimationFrame(animate);

    // gentle ‚Äúselected wobble‚Äù
    const t = performance.now();
    for(const b of blockGroup.children){
      if(!b.userData.alive) continue;
      if(b.userData.selected){
        b.position.y += Math.sin(t/260 + b.position.x*2 + b.position.z*2) * 0.0007;
      }
    }

    updateCamera();
    renderer.render(scene, camera);
  }

  // ---------- Round logic ----------
  function pickRound(level){
    const all = [...(FAMILY[level] || [])];
    for(let i=all.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [all[i],all[j]]=[all[j],all[i]];
    }
    return all.slice(0, Math.min(STATE.roundSize, all.length));
  }

  function startTimer(){
    STATE.startedAt = performance.now();
    if(STATE.timerId) clearInterval(STATE.timerId);
    STATE.timerId = setInterval(()=>{
      timeEl.textContent = fmtTime(performance.now() - STATE.startedAt);
    }, 250);
  }
  function stopTimer(){
    if(STATE.timerId) clearInterval(STATE.timerId);
    STATE.timerId = null;
  }
  function fmtTime(ms){
    const s = Math.max(0, Math.floor(ms/1000));
    const m = Math.floor(s/60);
    const r = s%60;
    return `${m}:${r<10?"0"+r:r}`;
  }

  function setMsg(text, kind){
    msgEl.style.display = "block";
    msgEl.className = "msg" + (kind ? " "+kind : "");
    msgEl.textContent = text;
  }
  function clearMsg(){
    msgEl.style.display = "none";
    msgEl.textContent = "";
    msgEl.className = "msg";
  }

  function renderRoundList(){
    roundList.innerHTML = "";
    STATE.round.forEach((it, idx)=>{
      const done = idx < STATE.done;
      const div = document.createElement("div");
      div.className = "chip" + (done ? " done" : "");
      div.innerHTML = `<span>${done ? "‚úÖ " : ""}${it.en}</span><small>${done ? "done" : "pending"}</small>`;
      roundList.appendChild(div);
    });
    leftEl.textContent = String(Math.max(0, STATE.round.length - STATE.done));
  }

  function clearSelection(){
    for(const b of STATE.selectedBlocks){
      b.userData.selected = false;
      const sideHex = b.userData.sideHex || 0xffffff;
      b.material.forEach((m,i)=>{
        if(m?.color && i !== 2) m.color.setHex(sideHex);
      });
      b.scale.set(1,1,1);
    }
    STATE.selectedBlocks = [];
    STATE.selectedText = "";
    spellingEl.textContent = "‚Äî";
  }

  function setCurrent(index){
    STATE.currentIndex = index;
    STATE.currentItem = STATE.round[index] || null;
    if(!STATE.currentItem) return;
    promptEl.textContent = `Spell: ${STATE.currentItem.en}`;
    STATE.acceptedAnswers = STATE.currentItem.answers.slice();
    clearSelection();
    clearMsg();
    hintLine.textContent = "Hints cost points and reset streak.";
  }

  function addLetter(block){
    STATE.selectedBlocks.push(block);
    STATE.selectedText += block.userData.letter;
    spellingEl.textContent = STATE.selectedText || "‚Äî";
  }

  function removeBlocks(blocks){
    const start = performance.now();
    const dur = 220;
    const anim = ()=>{
      const t = Math.min(1, (performance.now()-start)/dur);
      for(const b of blocks){
        b.scale.setScalar(1 - t);
      }
      if(t < 1) requestAnimationFrame(anim);
      else{
        for(const b of blocks){
          b.userData.alive = false;
          blockGroup.remove(b);
        }
      }
    };
    anim();
  }

  function scoreForCorrect(answerText){
    const elapsed = (performance.now() - STATE.startedAt)/1000;
    const speed = Math.max(0, Math.floor(175 - elapsed));
    const base = 130 + Math.min(220, norm(answerText).replace(/ /g,"").length * 18);
    const multi = 1 + Math.min(4, Math.floor(STATE.streak/3))*0.5;
    return Math.round((base + speed) * multi);
  }

  function endRound(){
    stopTimer();
    setMsg(`Round complete! Final score: ${STATE.score}. Tap ‚ÄúNew Round‚Äù to play again.`, "good");
    saveBestScore(STATE.level, STATE.score);
  }

  function submit(){
    if(!STATE.currentItem) return;
    const typed = STATE.selectedText.trim();
    if(!typed){
      setMsg("Pick some letter blocks first!", "bad");
      return;
    }

    const typedN = norm(typed);
    const ok = STATE.acceptedAnswers.some(a=>{
      const aN = norm(a);
      return (typedN === aN) || (typedN.replace(/ /g,"") === aN.replace(/ /g,""));
    });

    if(ok){
      const pts = scoreForCorrect(STATE.acceptedAnswers[0]);
      STATE.score += pts;
      STATE.streak += 1;
      scoreEl.textContent = String(STATE.score);
      streakEl.textContent = String(STATE.streak);

      setMsg(`‚úÖ Correct! +${pts} points`, "good");
      removeBlocks(STATE.selectedBlocks);

      STATE.done += 1;
      renderRoundList();

      if(STATE.done >= STATE.round.length){
        endRound();
      } else {
        setTimeout(()=> setCurrent(STATE.done), 280);
      }
      return;
    }

    STATE.streak = 0;
    streakEl.textContent = "0";
    STATE.score = Math.max(0, STATE.score - 60);
    scoreEl.textContent = String(STATE.score);
    setMsg("‚ùå Not quite. Try again (penalty ‚àí60).", "bad");
    clearSelection();
  }

  function useHint(){
    if(!STATE.currentItem) return;
    STATE.hintsUsed += 1;
    STATE.streak = 0;
    streakEl.textContent = "0";
    STATE.score = Math.max(0, STATE.score - 80);
    scoreEl.textContent = String(STATE.score);

    const any = STATE.acceptedAnswers[0] || "";
    const clean = norm(any);
    const first = clean[0] ? clean[0].toUpperCase() : "";
    const len = clean.replace(/ /g,"").length;
    hintLine.textContent = `Hint: starts with ‚Äú${first}‚Äù ¬∑ length ${len} (‚àí80 points)`;
  }

  // ---------- High scores (localStorage) ----------
  const scoreKey = (lvl)=> `family_tower_best_FINAL::L${lvl}`;
  function bestScore(lvl){
    const n = parseInt(localStorage.getItem(scoreKey(lvl)) || "0", 10);
    return Number.isFinite(n) ? n : 0;
  }
  function saveBestScore(lvl, score){
    const b = bestScore(lvl);
    if(score > b) localStorage.setItem(scoreKey(lvl), String(score));
  }
  function showScores(){
    const lines = [];
    for(let l=1;l<=10;l++){
      lines.push(`Level ${l}: ${bestScore(l)}`);
    }
    alert("High Scores (this device)\n\n" + lines.join("\n"));
  }

  // ---------- Picking (hover + click) ----------
  function pickFromPointer(ev){
    const rect = canvas.getBoundingClientRect();
    const x = ((ev.clientX - rect.left) / rect.width) * 2 - 1;
    const y = -(((ev.clientY - rect.top) / rect.height) * 2 - 1);
    mouse.set(x,y);
    raycaster.setFromCamera(mouse, camera);
    const hits = raycaster.intersectObjects(blockGroup.children, false);
    return hits.length ? hits[0].object : null;
  }

  function setHover(obj){
    if(hovered === obj) return;
    if(hovered && hovered.userData.alive && !hovered.userData.selected){
      const sideHex = hovered.userData.sideHex || 0xffffff;
      hovered.material.forEach((m,i)=>{ if(m?.color && i!==2) m.color.setHex(sideHex); });
    }
    hovered = obj;
    if(hovered && hovered.userData.alive && !hovered.userData.selected){
      hovered.material.forEach((m,i)=>{
        if(m?.color && i!==2){
          const c = new THREE.Color(m.color.getHex());
          c.offsetHSL(0, 0, 0.10);
          m.color.setHex(c.getHex());
        }
      });
    }
  }

  canvas.addEventListener("mousemove", (ev)=>{
    const obj = pickFromPointer(ev);
    setHover(obj);
  });
  canvas.addEventListener("mouseleave", ()=> setHover(null));

  canvas.addEventListener("click", (ev)=>{
    const obj = pickFromPointer(ev);
    if(!obj || !obj.userData.alive) return;
    if(obj.userData.selected) return;

    obj.userData.selected = true;

    // selected highlight
    obj.material.forEach((m,i)=>{
      if(m?.color && i!==2) m.color.setHex(new THREE.Color("#dff7ee").getHex());
    });
    obj.scale.set(1.06,1.06,1.06);

    addLetter(obj);

    // auto-submit if exact match
    const typedN = norm(STATE.selectedText);
    const exact = STATE.acceptedAnswers.some(a=> norm(a) === typedN);
    if(exact) submit();
  });

  // ---------- Drag rotate + wheel zoom ----------
  let dragging = false;
  let lastX = 0, lastY = 0;

  canvas.addEventListener("pointerdown", (e)=>{
    dragging = true;
    canvas.setPointerCapture(e.pointerId);
    lastX = e.clientX;
    lastY = e.clientY;
  });

  canvas.addEventListener("pointermove", (e)=>{
    if(!dragging) return;
    const dx = e.clientX - lastX;
    const dy = e.clientY - lastY;
    lastX = e.clientX;
    lastY = e.clientY;

    // ‚úÖ FIX: rotation NOT inverted
    theta += dx * 0.008;     // was -= (now feels natural)
    phi   += dy * 0.006;
    phi = Math.max(phiMin, Math.min(phiMax, phi));
  });

  canvas.addEventListener("pointerup", (e)=>{
    dragging = false;
    try{ canvas.releasePointerCapture(e.pointerId); }catch(_){}
  });

  canvas.addEventListener("wheel", (e)=>{
    e.preventDefault();
    radius += e.deltaY * 0.01;
    radius = Math.max(radMin, Math.min(radMax, radius));
  }, { passive:false });

  // ---------- New game / round ----------
  function newRound(){
    STATE.level = parseInt(levelSel.value, 10);
    levelBadge.textContent = String(STATE.level);
    applyLevelBackground(STATE.level);

    STATE.score = 0;
    STATE.streak = 0;
    STATE.hintsUsed = 0;
    STATE.done = 0;
    scoreEl.textContent = "0";
    streakEl.textContent = "0";
    clearMsg();

    STATE.round = pickRound(STATE.level);
    renderRoundList();
    setCurrent(0);

    buildTower(STATE.level);
    startTimer();

    // a touch more top-down as level increases (looks like ‚Äúprogression‚Äù)
    const t = (STATE.level-1)/9;
    phi = Math.max(phiMin, Math.min(phiMax, (Math.PI*0.32) - t*0.03));
    radius = Math.max(radMin, Math.min(radMax, 26 - t*4));
  }

  function shuffleTower(){
    buildTower(STATE.level);
    clearSelection();
    setMsg("Shuffled tower!", "");
    setTimeout(clearMsg, 900);
  }

  // ---------- Setup ----------
  for(let i=1;i<=10;i++){
    const opt = document.createElement("option");
    opt.value = String(i);
    opt.textContent = `Level ${i}`;
    levelSel.appendChild(opt);
  }
  levelSel.value = "1";

  btnNew.addEventListener("click", newRound);
  btnScores.addEventListener("click", showScores);
  btnSubmit.addEventListener("click", submit);
  btnClear.addEventListener("click", ()=>{ clearSelection(); clearMsg(); });
  btnShuffle.addEventListener("click", shuffleTower);
  btnHint.addEventListener("click", useHint);

  window.addEventListener("keydown", (e)=>{
    if(e.key === "Enter"){ e.preventDefault(); submit(); }
    if(e.key === "Backspace"){ clearSelection(); }
  });

  // initial
  resize();
  applyLevelBackground(1);
  levelBadge.textContent = "1";
  buildTower(1);
  promptEl.textContent = "Click New Round to begin!";
  renderRoundList();
  updateCamera();
  animate();
</script>
</body>
</html>
